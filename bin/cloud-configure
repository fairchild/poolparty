#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")
require "poolparty"
# require "poolpartycl"
require 'git-style-binary/command'

GitStyleBinary.command do  
  version "PoolParty #{$0} command"  
  banner <<-EOS
Usage: #{$0} #{all_options_string}

  Configure a cloud instance
EOS

  short_desc "Configure a cloud instance"
  
  opt :inst_num, "The number of the instance to run bootstrap on", :type => :int

  run do |command|    
    
    @loaded_clouds.each do |cld|
        
        # If an IP or DNS name is given, bootstrap that node, otherwise, bootstrap all running nodes.
        if cld.nodes(:status => "running").empty?
          puts "No nodes to bootstrap"
        else
          if command[:inst_num]
            vputs "\nConfiguring: #{cld.nodes[command[:inst_num]]}\n--------------------"
            address = cld.nodes(:status => "running")[ command[:inst_num] ]
            ::PoolParty::Provision::DrConfigure.new( address[:ip], :cloud => cld )
          else
            cld.nodes(:status => "running").each do |address|
              cld.vputs "\nConfiguring: #{address[:ip]}\n--------------------"      
              ::PoolParty::Provision::DrConfigure.new address[:ip], :cloud => cld
            end
          end
        end
      
    end
    
  end
end