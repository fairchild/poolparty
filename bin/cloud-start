#!/usr/bin/env ruby
$:.unshift(File.dirname(__FILE__) + "/../lib")
require "poolparty"
# require "poolpartycl"
require 'git-style-binary/command'

GitStyleBinary.command do  
  version "PoolParty #{$0} command"  
  banner <<-EOS
Usage: #{$0} #{all_options_string}

  starts a single instance in your cloud.
EOS

  short_desc "starts a single instance in your cloud"

  run do |command|    
    
    @loaded_clouds.each do |cld|

      if cld.nodes(:status => "running").size.zero?
        puts header("Starting cloud #{cld.name} (#{cld.keypair})")
        puts "#{cld.nodes(:status => "running").size} running instances (#{cld.minimum_instances} - #{cld.maximum_instances})"
        
        # (1..cld.minimum_instances).each do |_index|
          cld.launch_instance!(:cloud_name => cld.name) do |node|
            ::PoolParty::Provision::BootStrapper.new(node.ip, :cloud => cld)
            ::PoolParty::Provision::DrConfigure.new(node.ip,  :cloud => cld)
            puts <<-EOM
              Your cloud has started. Your ip is #{node.ip}
            EOM
          end
        # end
      
      else
        puts <<-EOE
          Your cloud is already running.
        EOE
      end
      
    end
    
  end
end